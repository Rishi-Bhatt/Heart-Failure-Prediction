\begin{figure*}[ht]
\centering
\resizebox{\textwidth}{!}{%
\begin{tikzpicture}[
    node distance=1.5cm,
    box/.style={rectangle, draw, fill=blue!10, rounded corners, minimum width=4cm, minimum height=1cm, align=center},
    subbox/.style={rectangle, draw, fill=blue!5, rounded corners, minimum width=3.5cm, minimum height=0.8cm, align=center, font=\small},
    arrow/.style={thick,->,>=stealth},
    module/.style={rectangle, draw, fill=gray!20, text width=5cm, minimum height=1.5cm, align=center, font=\bfseries}
]

% Main modules
\node[module] (acquisition) {DATA ACQUISITION};
\node[module, below=2cm of acquisition] (preprocessing) {DATA PREPROCESSING};
\node[module, below=2cm of preprocessing] (engineering) {FEATURE ENGINEERING};
\node[module, below=2cm of engineering] (longitudinal) {LONGITUDINAL TRACKING};
\node[module, below=2cm of longitudinal] (prediction) {PREDICTION PIPELINE};
\node[module, below=2cm of prediction] (forecasting) {RISK FORECASTING};
\node[module, below=2cm of forecasting] (counterfactual) {COUNTERFACTUAL GENERATION};
\node[module, below=2cm of counterfactual] (explanation) {EXPLANATION GENERATION};
\node[module, below=2cm of explanation] (visualization) {VISUALIZATION};
\node[module, below=2cm of visualization] (decision) {CLINICAL DECISION SUPPORT};

% Connect main modules
\draw[arrow] (acquisition) -- (preprocessing);
\draw[arrow] (preprocessing) -- (engineering);
\draw[arrow] (engineering) -- (longitudinal);
\draw[arrow] (longitudinal) -- (prediction);
\draw[arrow] (prediction) -- (forecasting);
\draw[arrow] (forecasting) -- (counterfactual);
\draw[arrow] (counterfactual) -- (explanation);
\draw[arrow] (explanation) -- (visualization);
\draw[arrow] (visualization) -- (decision);

% Data Acquisition submodules
\node[subbox, right=1cm of acquisition] (input) {Patient Data Input\\Demographics, Clinical Parameters,\\Lab Results, ECG Data, NT-proBNP};
\node[subbox, below=0.5cm of input] (validation) {Data Validation\\Range Checking, Completeness,\\Format Validation};

% Preprocessing submodules
\node[subbox, right=1cm of preprocessing] (missing) {Missing Value Handling\\Median Imputation, Mode Imputation,\\Clinical Knowledge-Based Imputation};
\node[subbox, below=0.5cm of missing] (scaling) {Feature Scaling\\Z-score Normalization,\\Min-Max Scaling, Log Transformations};
\node[subbox, below=0.5cm of scaling] (encoding) {Categorical Encoding\\One-hot Encoding, Binary Encoding};

% Feature Engineering submodules
\node[subbox, right=1cm of engineering] (ntprobnp) {NT-proBNP Processing\\Age-adjusted Thresholds,\\Sigmoid Normalization};
\node[subbox, below=0.5cm of ntprobnp] (ecgfeature) {ECG Feature Extraction\\Abnormality Detection, Rhythm Analysis};
\node[subbox, below=0.5cm of ecgfeature] (interaction) {Interaction Terms\\Age-BP, NT-proBNP-Age};

% Longitudinal Tracking submodules
\node[subbox, right=1cm of longitudinal] (history) {Patient History Retrieval\\Chronological Data, Visit Records};
\node[subbox, below=0.5cm of history] (temporal) {Temporal Feature Extraction\\Parameter Slopes, Volatility Measures};
\node[subbox, below=0.5cm of temporal] (storage) {Longitudinal Data Storage\\Timestamped Records, Versioned Data};

% Prediction Pipeline submodules
\node[subbox, right=1cm of prediction] (integration) {Data Integration Layer\\Current + Historical, Clinical + Biomarker};
\node[subbox, below=0.5cm of integration] (rulebased) {Rule-Based Model\\Clinical Guidelines, Threshold Rules};
\node[subbox, below=0.5cm of rulebased] (logistic) {Logistic Regression Model\\Trained on UCI Data};
\node[subbox, below=0.5cm of logistic] (forest) {Random Forest Model\\500 Decision Trees, Feature Importance};
\node[subbox, below=0.5cm of forest] (hybrid) {Hybrid Model Integration\\Dynamic Weighting, Final Risk Score};

% Risk Forecasting submodules
\node[subbox, right=1cm of forecasting] (trend) {Trend Analysis\\Parameter Trends, Risk Score Trends};
\node[subbox, below=0.5cm of trend] (extrapolation) {Temporal Extrapolation\\Linear Projection, Decay Functions};
\node[subbox, below=0.5cm of extrapolation] (forecastmodel) {Risk Forecasting Model\\6-month, 1-year, 2-year Forecasts};
\node[subbox, below=0.5cm of forecastmodel] (impact) {Intervention Impact Modeling\\Medication Effects, Lifestyle Changes};

% Counterfactual Generation submodules
\node[subbox, right=1cm of counterfactual] (modifiable) {Modifiable Factor Identification\\Clinical Constraints, Intervention Options};
\node[subbox, below=0.5cm of modifiable] (optimization) {Counterfactual Optimization\\Distance Minimization, Clinical Validity};
\node[subbox, below=0.5cm of optimization] (multistep) {Multi-step Intervention Paths\\Sequential Changes, Progressive Risk Reduction};
\node[subbox, below=0.5cm of multistep] (grouping) {Intervention Grouping\\Lifestyle, Medication, Monitoring Groups};

% Explanation Generation submodules
\node[subbox, right=1cm of explanation] (contribution) {Feature Contribution Calculation\\SHAP-like Values, Direction Factors};
\node[subbox, below=0.5cm of contribution] (riskfactor) {Risk Factor Explanation\\Top Contributors, Clinical Significance};
\node[subbox, below=0.5cm of riskfactor] (cfexplain) {Counterfactual Explanation\\What-if Scenarios, Intervention Effects};
\node[subbox, below=0.5cm of cfexplain] (confidenceexp) {Confidence Explanation\\Uncertainty Sources, Model Agreement};

% Visualization submodules
\node[subbox, right=1cm of visualization] (dashboard) {Risk Dashboard\\Current Risk Display, Historical Trend};
\node[subbox, below=0.5cm of dashboard] (tempviz) {Temporal Visualization\\Parameter Trends, Risk Trajectories};
\node[subbox, below=0.5cm of tempviz] (ecgviz) {ECG Visualization\\Signal Display, Abnormality Markers};
\node[subbox, below=0.5cm of ecgviz] (cfviz) {Counterfactual Visualization\\Intervention Impact, Before/After View};

% Clinical Decision Support submodules
\node[subbox, right=1cm of decision] (treatment) {Treatment Recommendations\\Prioritized Actions, Evidence Links};
\node[subbox, below=0.5cm of treatment] (monitoring) {Risk Monitoring\\Follow-up Schedule, Alert Thresholds};
\node[subbox, below=0.5cm of monitoring] (education) {Patient Education\\Risk Explanation, Intervention Benefits};
\node[subbox, below=0.5cm of education] (documentation) {Clinical Documentation\\Risk Assessment, Intervention Plan};

% Connect submodules to main modules
\draw[arrow] (input) -- (validation);
\draw[arrow] (missing) -- (scaling);
\draw[arrow] (scaling) -- (encoding);
\draw[arrow] (ntprobnp) -- (ecgfeature);
\draw[arrow] (ecgfeature) -- (interaction);
\draw[arrow] (history) -- (temporal);
\draw[arrow] (temporal) -- (storage);
\draw[arrow] (integration) -- (rulebased);
\draw[arrow] (rulebased) -- (logistic);
\draw[arrow] (logistic) -- (forest);
\draw[arrow] (forest) -- (hybrid);
\draw[arrow] (trend) -- (extrapolation);
\draw[arrow] (extrapolation) -- (forecastmodel);
\draw[arrow] (forecastmodel) -- (impact);
\draw[arrow] (modifiable) -- (optimization);
\draw[arrow] (optimization) -- (multistep);
\draw[arrow] (multistep) -- (grouping);
\draw[arrow] (contribution) -- (riskfactor);
\draw[arrow] (riskfactor) -- (cfexplain);
\draw[arrow] (cfexplain) -- (confidenceexp);
\draw[arrow] (dashboard) -- (tempviz);
\draw[arrow] (tempviz) -- (ecgviz);
\draw[arrow] (ecgviz) -- (cfviz);
\draw[arrow] (treatment) -- (monitoring);
\draw[arrow] (monitoring) -- (education);
\draw[arrow] (education) -- (documentation);

% Additional connections between modules
\draw[arrow, dashed, color=red] (storage.west) to[out=180,in=180] (integration.west);
\draw[arrow, dashed, color=red] (hybrid.east) to[out=0,in=0] (trend.east);
\draw[arrow, dashed, color=red] (impact.west) to[out=180,in=180] (modifiable.west);
\draw[arrow, dashed, color=red] (grouping.east) to[out=0,in=0] (contribution.east);

\end{tikzpicture}
}
\caption{Detailed Heart Failure Prediction System: Data Flow and Processing Pipeline}
\label{fig:detailed-system-flowchart}
\end{figure*}
